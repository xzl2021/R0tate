var canvas = document.getElementById('canvas'),
    canvasHeight = canvas.height,
    canvasWidth = canvas.width,
    ctx = canvas.getContext('2d'),
    mapOriginX = canvasWidth/2;
    mapOriginY = canvasHeight/2 + 100;
    segment = 16,
    keys = ['',''],
    // rotateOffset = -4000;
    rotateOffset = 0;
    // map = (function () {
    //   var arr = [];
    //   var left = -426;
    //   for (var i = 0; i < 30; i++) {
    //     arr.push([30,90,left]);
    //     left += 16;
    //   }
    //   return arr;
    // }());


var map =
[
  [30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],
  [30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],
  [30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],
  // [30, 630],
  [30,210],
  [150,210],[150,210],[150,210],[150,210],
  [150,330],
  [270,330],[270,330],[270,330],[270,330],
  [],[],[],[],
  [270,330],[270,330],[270,330],
  [150,330],[150,210],[30,210],
  [30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90,390,510],[30,90,390,450],
  [30,210,390,450],[150,210],[150,210],[150,270],
  [510,570],[510,570],[510,570],[510,570],[510,570],[510,570],[510,570],[510,570],
  [330,570],[330,390],[330,390],[150,390],
  [150,210],[150,210],[150,210],[150,210,390,450],[150,210,390,450],[150,210,270,570],[150,210,270,330,390,450,510,570],[150,210,270,570],[150,210,270,330,390,450,510,570],[150,210,270,570],
  [150,210],[150,210],[150,210,510,570],[150,210],[150,210],[150,210,270,570],[150,210,270,330,390,450,510,570],[150,210,270,570],[150,210,270,330,390,450,510,570],[150,210,270,570],[150,210],[150,210],
  [150,390],[330,390],[330,390],[330,390],[330,390],[330,390],
  [270,390],[210,330],[150,270],[90,210],[30,150],
  [30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90,270,690],[30,90,270,330],[30,90],[30,90],[30,90],
  [30,150,450,510],[30,510],
  [30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],
  [30,210],[30,90],[30,90],[30,90],[30,210],[30,90],[30,90],[30,90],[30,210],[30,90],[30,90],[30,90],[30,210],[30,90],[30,90],[30,90],[30,210],[30,90],[30,90],[30,90],[30,210],
  [30,90],[30,90,450,570],[30,90,390,510],[30,150,330,450],[90,210],[150,270],[210,330,510,570],[510,570],[510,570],[510,570],
  [450,570],[390,510],[330,450],[270,390],[210,330],[150,270],
  [150,210],[150,210],
  [150,270],[210,330],[270,390],[330,450],
  [390,450],[390,450],
  [],[],[],[],
  [30,90],[30,150],[90,210],[150,270],[210,330],[270,390],[330,450],[390,450],
  [],[],[],[],[],
  [30,90],[30,90],[30,90],[30,210],[30,210],
  [],[],[],[],
  [150,270],[150,270],
  [],[],[],[],
  [270,390],[270,390],
  [],[],[],[],
  [30,150],[30,150],
  [],[],[],[],
  [150,270],[150,270],
  [],[],[],[],
  [90,210],[90,210],
  [],[],[],[],
  [30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],
  [30,270],[210,450],
  [390,450],[390,450],[330,450],[330,390],[330,390],[270,390],[270,330],[270,330],
  [90,330],[30,150],
  [30,90],[30,90],[30,90],
  [30,210],[150,330],[270,450],[390,450],[390,450],[390,450],
  [210,570],[210,270],[210,270],[90,390],[90,150],[90,150],[30,270],[30,90],[30,90],[30,150],
  [30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],
  [30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],
  [30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],[30,90],
];


// for (var i = 0; i < map.length; i++) {
//   map[i].push(i * 16 - 426);
// }



function deg2rad(deg) {
  return deg*Math.PI/180;
}



window.addEventListener('keydown', function (e) {
  e.preventDefault();
  if (e.keyCode == 37 && keys[0] != 'l') {
    keys.pop();
    keys.unshift('l');
  }else if (e.keyCode == 39 && keys[0] != 'r') {
    keys.pop();
    keys.unshift('r');
  // }else if (!p.jump && e.keyCode == 32) {
  //   p.jump = true;
  //   pJump();
  }
});


window.addEventListener('keyup', function (e) {
  if (e.keyCode == 37 && keys[1] == 'l') {
    keys[1] = '';
  }else if (e.keyCode == 39 && keys[1] == 'r') {
    keys[1] = '';
  }else if (e.keyCode == 37 || e.keyCode == 39) {
    keys.shift();
    keys.push('');
  }
});


function getLeft(index) {
  return index * 16 - 426;
}


function drawMap() {
  var index = Math.floor(rotateOffset / -16) + 10;  //从第10个方块开始
  console.log(index);
  // p.pos = index + 11;
  for (var i = index; i < index + 22; i++) {  //可视范围内只显示22个方块
    var temp = i % 331;
    var currentBlock = map[temp]; //当前方块
    if (currentBlock === []) { //判断方块是否为空
      continue; //方块为空继续跳到下一循环
    }
    var left = getLeft(i) + rotateOffset; //当前方块的左边缘角度
    var color = 242 - ~~(Math.abs(-90 - left) / 170 * 242); //根据左边缘与角色的距离来设置颜色
    ctx.fillStyle = 'rgb(' + color + ',' + color + ',' + color + ')';
    // ctx.strokeStyle = '#fff';
    for (var j = currentBlock.length - 1; j > 0; j -= 2) {
      ctx.beginPath();
      ctx.arc(800, 900, currentBlock[j], deg2rad(left - 0.5), deg2rad(left + segment), false);
      ctx.arc(800, 900, currentBlock[j-1], deg2rad(left + segment), deg2rad(left - 0.5), true);
      ctx.closePath();
      ctx.fill();
      // ctx.stroke();
    }
  }
}



function pMove() {
  switch (keys[0]) {
    case 'l':
      ctx.clearRect(0,0,1600,1600);
      rotateOffset += 2;
      drawMap();
      break;
    case 'r':
      ctx.clearRect(0,0,1600,1600);
      rotateOffset -= 2;
      drawMap();
      break;
    default:

  }
}


!function render() {
  // ctx.clearRect(0,0,1600,1600);
  pMove();
  // drawMap();
  requestAnimationFrame(render);
}();
